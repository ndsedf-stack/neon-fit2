<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>NEON FIT // QG</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700;800;900&family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="program-data-v2.js?v=1764354000"></script>
  <script src="app-v2.js?v=1764354000"></script>
  <script src="cloud-sync-supabase.js"></script>
  <script src="stats-data.js"></script>

  <style>
    :root {
      --void: #020408;
      --cyan: #22d3ee;
      --cyan-dim: #06b6d4;
      --purple: #c084fc;
      --accent: #f59e0b;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      background-color: var(--void);
      font-family: 'Inter', sans-serif;
      color: #f8fafc;
      overflow-x: hidden;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    .font-hud { font-family: 'Chakra Petch', sans-serif; }
    
    .nebula {
      position: fixed;
      width: 600px;
      height: 600px;
      border-radius: 50%;
      filter: blur(120px);
      opacity: 0;
      z-index: 0;
      pointer-events: none;
      animation: nebulaFade 2s ease-out 0.5s forwards;
    }
    
    @keyframes nebulaFade { to { opacity: 0.08; } }
    
    .nebula.cyan { top: -15%; left: -15%; background: #164e63; }
    .nebula.purple { bottom: -15%; right: -15%; background: #581c87; }
    
    .grain-overlay {
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
      opacity: 0.02;
      pointer-events: none;
      z-index: 999;
      mix-blend-mode: screen;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    .xp-fill {
      background: linear-gradient(90deg, var(--cyan), #fff, var(--cyan));
      background-size: 200% 100%;
      animation: shimmer 3s infinite linear;
      box-shadow: 0 0 12px var(--cyan);
    }
    
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-entry {
      animation: slideInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      opacity: 0;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 20px;
      transition: all 0.3s ease;
    }
    
    .card:hover {
      border-color: rgba(34, 211, 238, 0.15);
      transform: translateY(-2px);
    }
    
    .card-glow {
      box-shadow: 0 0 40px rgba(34, 211, 238, 0.08);
      border-color: rgba(34, 211, 238, 0.2);
    }
    
    .ring-progress {
      transform: rotate(-90deg);
    }
    
    .mission-card {
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.05), rgba(139, 92, 246, 0.05));
      border: 1px solid rgba(34, 211, 238, 0.2);
      border-radius: 24px;
      overflow: hidden;
      position: relative;
    }
    
    .mission-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(34, 211, 238, 0.5), transparent);
    }
    
    .launch-btn {
      background: linear-gradient(135deg, var(--cyan), #0891b2);
      box-shadow: 0 0 25px rgba(34, 211, 238, 0.3);
      transition: all 0.3s ease;
    }
    
    .launch-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 0 40px rgba(34, 211, 238, 0.5);
    }
    
    .launch-btn:active {
      transform: scale(0.98);
    }
    
    .stat-mini {
      text-align: center;
      padding: 12px 8px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 900;
      line-height: 1;
    }
    
    .nav-btn {
      transition: all 0.2s ease;
    }
    
    .nav-btn:active {
      transform: scale(0.95);
    }
    
    .nav-btn.active {
      color: var(--cyan);
    }
    
    .zap-btn {
      background: linear-gradient(135deg, var(--cyan) 0%, #0891b2 100%);
      box-shadow: 0 0 30px rgba(34, 211, 238, 0.4);
      transition: all 0.3s ease;
    }
    
    .zap-btn:active {
      transform: scale(0.9);
    }
    
    @supports (-webkit-touch-callout: none) {
      body { -webkit-overflow-scrolling: touch; }
    }
  </style>
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function() {
        navigator.serviceWorker.register("/sw.js").then(function(reg) {
          console.log("SW registered");
          reg.update();
        });
      });
    }
  </script>
</head>

<body class="antialiased pb-28">
  <div class="grain-overlay"></div>
  <div class="nebula cyan"></div>
  <div class="nebula purple"></div>
  
  <header class="sticky top-0 z-50 bg-[#020408]/90 backdrop-blur-xl border-b border-white/5 px-4 py-3" style="padding-top: max(12px, env(safe-area-inset-top));">
    <div class="flex justify-between items-center mb-2">
      <div>
        <span class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.15em]">Rang</span>
        <div class="font-hud text-lg font-black uppercase tracking-wide" style="color: var(--cyan); text-shadow: 0 0 10px rgba(34, 211, 238, 0.4);" id="user-rank">RECRUE</div>
      </div>
      
      <div id="cloud-sync-ui" class="flex items-center"></div>
      
      <div class="text-right">
        <span class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.15em]">XP</span>
        <div class="font-hud text-lg font-black" style="color: var(--cyan);" id="xp-display">0</div>
      </div>
    </div>
    
    <div class="h-1.5 w-full bg-slate-800/50 rounded-full overflow-hidden">
      <div class="h-full xp-fill" id="xp-bar" style="width: 0%"></div>
    </div>
  </header>

  <main class="relative z-10 px-4 pt-4 space-y-4">

    <section class="animate-entry" style="animation-delay: 0s;">
      <div class="card p-4">
        <div class="grid grid-cols-4 divide-x divide-white/5">
          <div class="stat-mini">
            <i data-lucide="flame" class="w-5 h-5 mx-auto mb-1 text-orange-500"></i>
            <div class="stat-value font-hud text-white" id="streak-days">0</div>
            <div class="text-[8px] font-bold text-slate-500 uppercase tracking-wider mt-1">Série</div>
          </div>
          <div class="stat-mini">
            <i data-lucide="trophy" class="w-5 h-5 mx-auto mb-1 text-amber-400"></i>
            <div class="stat-value font-hud text-white" id="total-sessions">0</div>
            <div class="text-[8px] font-bold text-slate-500 uppercase tracking-wider mt-1">Séances</div>
          </div>
          <div class="stat-mini">
            <i data-lucide="dumbbell" class="w-5 h-5 mx-auto mb-1 text-purple-400"></i>
            <div class="stat-value font-hud text-white" id="total-volume">0</div>
            <div class="text-[8px] font-bold text-slate-500 uppercase tracking-wider mt-1">Tonnes</div>
          </div>
          <div class="stat-mini">
            <i data-lucide="zap" class="w-5 h-5 mx-auto mb-1" style="color: var(--cyan);"></i>
            <div class="stat-value font-hud text-white" id="level-display">1</div>
            <div class="text-[8px] font-bold text-slate-500 uppercase tracking-wider mt-1">Niveau</div>
          </div>
        </div>
      </div>
    </section>

    <section class="animate-entry" style="animation-delay: 0.1s;">
      <div class="card card-glow p-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="w-1.5 h-1.5 rounded-full animate-pulse" style="background: var(--cyan);"></span>
          <span class="text-[9px] font-bold uppercase tracking-[0.2em]" style="color: var(--cyan);">Protocole Actif</span>
        </div>
        
        <div class="flex justify-between items-start mb-3">
          <div>
            <h2 class="text-xl font-hud font-black text-white uppercase tracking-wide" id="protocol-title">LOADING</h2>
            <div class="text-sm font-hud font-medium text-slate-400" id="protocol-subtitle">Bloc 1</div>
          </div>
          <div class="text-center px-3 py-1 rounded-lg" style="background: rgba(34, 211, 238, 0.1);">
            <div class="text-[8px] text-slate-500 font-bold uppercase">Sem</div>
            <div class="text-xl font-hud font-bold" style="color: var(--cyan);" id="protocol-week">01</div>
          </div>
        </div>
        
        <div class="flex items-center gap-2 mb-3">
          <span class="text-[9px] font-bold px-2 py-1 rounded" style="color: var(--cyan); background: rgba(34, 211, 238, 0.1);" id="protocol-tech">TEMPO</span>
          <span class="text-[9px] font-bold text-amber-400 bg-amber-400/10 px-2 py-1 rounded" id="protocol-rpe">RPE 6-7</span>
        </div>
        
        <div class="flex gap-1 h-1" id="protocol-bar"></div>
      </div>
    </section>

    <section class="animate-entry" style="animation-delay: 0.2s;">
      <div class="flex items-center justify-between mb-3 px-1">
        <h2 class="text-xs font-bold text-white uppercase tracking-[0.15em] flex items-center gap-2">
          <i data-lucide="crosshair" class="w-4 h-4" style="color: var(--cyan);"></i>
          Prochaine Mission
        </h2>
        <span class="text-[9px] font-bold text-slate-500 uppercase">Semaine <span id="week-num">01</span></span>
      </div>
      
      <div class="mission-card p-5" id="next-mission">
        <div class="flex justify-between items-start mb-4">
          <div>
            <div class="text-[9px] font-bold text-cyan-400 uppercase tracking-wider mb-1" id="mission-day">MARDI</div>
            <h3 class="text-xl font-hud font-black text-white uppercase" id="mission-name">DOS + JAMBES</h3>
            <p class="text-sm text-slate-400 mt-1" id="mission-muscles">5 exercices</p>
          </div>
          <div class="text-right">
            <div class="text-2xl font-hud font-black" style="color: var(--cyan);">+<span id="mission-xp">500</span></div>
            <div class="text-[9px] text-slate-500 font-bold">XP</div>
          </div>
        </div>
        
        <div class="flex items-center gap-4 text-sm text-slate-300 mb-4">
          <span class="flex items-center gap-1">
            <i data-lucide="clock" class="w-4 h-4" style="color: var(--cyan);"></i>
            <span id="mission-duration">60</span> min
          </span>
          <span class="flex items-center gap-1">
            <i data-lucide="layers" class="w-4 h-4 text-purple-400"></i>
            <span id="mission-sets">25</span> séries
          </span>
          <span class="flex items-center gap-1">
            <i data-lucide="weight" class="w-4 h-4 text-amber-400"></i>
            <span id="mission-volume">2.5</span>t
          </span>
        </div>
        
        <a href="#" id="launch-mission-btn" class="launch-btn block w-full py-4 rounded-xl text-center font-hud font-black text-black text-lg uppercase tracking-wider">
          Lancer la Mission
        </a>
      </div>
    </section>

    <section class="animate-entry" style="animation-delay: 0.3s;">
      <div class="flex items-center justify-between mb-3 px-1">
        <h2 class="text-xs font-bold text-white uppercase tracking-[0.15em] flex items-center gap-2">
          <i data-lucide="list" class="w-4 h-4 text-slate-400"></i>
          Autres Missions
        </h2>
      </div>
      
      <div class="space-y-2" id="other-missions"></div>
    </section>

    <section class="animate-entry" style="animation-delay: 0.4s;">
      <div class="card p-4">
        <div class="flex items-start gap-3">
          <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: rgba(34, 211, 238, 0.1);">
            <i data-lucide="quote" class="w-4 h-4" style="color: var(--cyan);"></i>
          </div>
          <p class="flex-1 font-hud text-base italic text-slate-300 leading-relaxed" id="daily-quote">
            "La douleur est temporaire. L'abandon est définitif."
          </p>
        </div>
      </div>
    </section>

  </main>

  <nav class="fixed bottom-0 left-0 right-0 z-50 bg-[#0a0a12]/95 backdrop-blur-xl border-t border-white/5" style="padding-bottom: max(8px, env(safe-area-inset-bottom));">
    <div class="flex justify-around items-center h-16 max-w-md mx-auto">
      <a href="index.html" class="nav-btn active flex flex-col items-center gap-1 px-4">
        <i data-lucide="layout-grid" class="w-5 h-5"></i>
        <span class="text-[9px] font-bold uppercase">QG</span>
      </a>
      
      <a href="workouts.html" class="nav-btn flex flex-col items-center gap-1 px-4 text-slate-500">
        <i data-lucide="target" class="w-5 h-5"></i>
        <span class="text-[9px] font-bold uppercase">Ops</span>
      </a>
      
      <button id="quick-launch-btn" class="zap-btn w-14 h-14 rounded-full flex items-center justify-center -mt-6 border-4 border-[#0a0a12]">
        <i data-lucide="zap" class="w-7 h-7 text-black"></i>
      </button>
      
      <a href="stats.html" class="nav-btn flex flex-col items-center gap-1 px-4 text-slate-500">
        <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
        <span class="text-[9px] font-bold uppercase">Stats</span>
      </a>
      
      <a href="#" onclick="alert('Bientôt disponible')" class="nav-btn flex flex-col items-center gap-1 px-4 text-slate-500">
        <i data-lucide="user" class="w-5 h-5"></i>
        <span class="text-[9px] font-bold uppercase">ID</span>
      </a>
    </div>
  </nav>

  <script>
    function initIcons() {
      if (window.lucide) lucide.createIcons();
    }

    function loadStats() {
      if (!window.StatsData) return;
      
      const history = StatsData.getHistory();
      const totalSessions = history.length > 0 ? new Set(history.map(function(h) { return h.date; })).size : 0;
      document.getElementById('total-sessions').textContent = totalSessions;
      
      var totalVolume = 0;
      history.forEach(function(entry) {
        var weight = parseFloat(entry.weight) || 0;
        var reps = parseInt(entry.reps) || 0;
        totalVolume += weight * reps;
      });
      document.getElementById('total-volume').textContent = (totalVolume / 1000).toFixed(1);
      
      var streak = parseInt(localStorage.getItem('hybrid_streak') || '0');
      document.getElementById('streak-days').textContent = streak;
    }

    function loadGamification() {
      if (!window.Gamification) return;
      Gamification.updateUI();
      
      var quoteEl = document.getElementById('daily-quote');
      var randomQuote = Gamification.getRandomQuote();
      quoteEl.textContent = '"' + randomQuote + '"';
    }

    function populateProtocolWidget(currentWeek) {
      if (!window.programData) return;
      
      var weekData = window.programData.getWeek(currentWeek);
      var blockName = window.programData.info.blockTechniques['block' + weekData.block]?.name || 'Unknown';
      
      document.getElementById('protocol-title').textContent = blockName.toUpperCase();
      document.getElementById('protocol-subtitle').textContent = 'Bloc ' + weekData.block;
      document.getElementById('protocol-tech').textContent = weekData.technique.toUpperCase();
      document.getElementById('protocol-rpe').textContent = 'RPE ' + weekData.rpeTarget;
      document.getElementById('protocol-week').textContent = String(currentWeek).padStart(2, '0');
      
      var weeksInBlock = 5;
      var currentWeekInBlock = ((currentWeek - 1) % 5) + 1;
      var segmentContainer = document.getElementById('protocol-bar');
      segmentContainer.innerHTML = '';
      
      for (var i = 1; i <= weeksInBlock; i++) {
        var seg = document.createElement('div');
        var isActive = i <= currentWeekInBlock;
        seg.className = 'flex-1 rounded-full h-full ' + (isActive ? '' : 'bg-white/10');
        if (isActive) {
          seg.style.background = 'var(--cyan)';
          seg.style.boxShadow = '0 0 5px var(--cyan)';
        }
        segmentContainer.appendChild(seg);
      }
    }

    function findNextMission(currentWeek) {
      if (!window.programData) return null;
      
      var weekData = window.programData.getWeek(currentWeek);
      var days = ['dimanche', 'mardi', 'vendredi'];
      var completedDays = JSON.parse(localStorage.getItem('completed_days_week_' + currentWeek) || '[]');
      
      for (var i = 0; i < days.length; i++) {
        var day = days[i];
        if (!completedDays.includes(day) && weekData[day]) {
          return { day: day, workout: weekData[day], week: currentWeek };
        }
      }
      
      return { day: 'dimanche', workout: weekData['dimanche'], week: currentWeek };
    }

    function populateMissions(currentWeek) {
      if (!window.programData) return;
      
      var weekData = window.programData.getWeek(currentWeek);
      var nextMission = findNextMission(currentWeek);
      var days = ['dimanche', 'mardi', 'vendredi'];
      var completedDays = JSON.parse(localStorage.getItem('completed_days_week_' + currentWeek) || '[]');
      
      if (nextMission && nextMission.workout) {
        var workout = nextMission.workout;
        var vol = 0;
        var totalSets = 0;
        workout.exercises.forEach(function(ex) {
          var r = typeof ex.reps === 'string' ? 8 : ex.reps;
          vol += ex.sets * r * ex.weight;
          totalSets += ex.sets;
        });
        
        document.getElementById('mission-day').textContent = nextMission.day.toUpperCase();
        document.getElementById('mission-name').textContent = workout.name.split('+')[0].trim();
        document.getElementById('mission-muscles').textContent = workout.exercises.length + ' exercices';
        document.getElementById('mission-duration').textContent = workout.duration;
        document.getElementById('mission-sets').textContent = totalSets;
        document.getElementById('mission-volume').textContent = (vol / 1000).toFixed(1);
        document.getElementById('mission-xp').textContent = '500';
        
        var launchBtn = document.getElementById('launch-mission-btn');
        launchBtn.href = 'briefing.html?week=' + currentWeek + '&day=' + nextMission.day;
        
        var quickLaunchBtn = document.getElementById('quick-launch-btn');
        quickLaunchBtn.onclick = function() {
          window.location.href = 'session.html?week=' + currentWeek + '&day=' + nextMission.day;
        };
      }
      
      var otherContainer = document.getElementById('other-missions');
      otherContainer.innerHTML = '';
      
      days.forEach(function(day) {
        if (nextMission && day === nextMission.day) return;
        
        var workout = weekData[day];
        if (!workout) return;
        
        var isCompleted = completedDays.includes(day);
        var vol = 0;
        workout.exercises.forEach(function(ex) {
          var r = typeof ex.reps === 'string' ? 8 : ex.reps;
          vol += ex.sets * r * ex.weight;
        });
        
        var card = document.createElement('a');
        card.href = 'briefing.html?week=' + currentWeek + '&day=' + day;
        card.className = 'card flex items-center justify-between p-4 ' + (isCompleted ? 'opacity-50' : '');
        
        card.innerHTML = '<div class="flex items-center gap-3">' +
          (isCompleted ? '<div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-green-400"></i></div>' : '<div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center"><i data-lucide="circle" class="w-4 h-4 text-slate-500"></i></div>') +
          '<div>' +
            '<div class="text-[9px] font-bold text-slate-500 uppercase">' + day + '</div>' +
            '<div class="text-sm font-hud font-bold text-white">' + workout.name.split('+')[0].trim() + '</div>' +
          '</div>' +
        '</div>' +
        '<div class="flex items-center gap-3 text-xs text-slate-400">' +
          '<span>' + workout.duration + 'm</span>' +
          '<span>' + (vol / 1000).toFixed(1) + 't</span>' +
          '<i data-lucide="chevron-right" class="w-4 h-4"></i>' +
        '</div>';
        
        otherContainer.appendChild(card);
      });
      
      initIcons();
    }

    function initDashboard() {
      console.log('Init dashboard...');
      
      if (!window.programData) {
        console.error('programData not loaded!');
        return;
      }
      
      initIcons();
      loadStats();
      loadGamification();
      
      var currentWeek = parseInt(localStorage.getItem('hybrid_current_week') || '1');
      document.getElementById('week-num').textContent = String(currentWeek).padStart(2, '0');
      
      populateProtocolWidget(currentWeek);
      populateMissions(currentWeek);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDashboard);
    } else {
      initDashboard();
    }
  </script>
</body>
</html>
