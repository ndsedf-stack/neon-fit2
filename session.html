<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>SESSION // COCKPIT TACTIQUE</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { cyan: '#22d3ee', fuchsia: '#c084fc' },
          animation: { 
            'pulse': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'shimmer': 'shimmer 2s infinite',
            'slideIn': 'slideIn 0.5s ease-out forwards',
            'sweep': 'sweep 3s infinite linear'
          },
          keyframes: {
            shimmer: { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
            slideIn: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            sweep: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } }
          }
        }
      }
    }
  </script>
  
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "lucide-react": "https://esm.sh/lucide-react@0.300.0"
    }
  }
  </script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="program-data-v2.js"></script>
  
  <style>
    :root { --cyan: #22d3ee; --magenta: #c084fc; --bg: #000000; }
    html, body, #root { height: 100%; height: 100dvh; margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Inter', sans-serif; color: white; touch-action: manipulation; }
    .animate-shimmer { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); background-size: 200% 100%; animation: shimmer 2s infinite; }
  </style>
</head>

<body>
  <div id="root"></div>
  
  <script type="text/babel" data-type="module">
    import React, { useEffect, useState, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { ArrowDown, ArrowUp, Target, User, Plus, Minus, AlertTriangle, Wind, Timer, SkipForward } from 'lucide-react';

    const urlParams = new URLSearchParams(window.location.search);
    const weekNum = parseInt(urlParams.get('week')) || parseInt(localStorage.getItem('hybrid_current_week')) || 1;
    const dayKey = urlParams.get('day') || 'dimanche';
    
    const pData = window.programData;
    let workoutData = null;
    let weekData = null;
    
    try {
      weekData = pData.getWeek(weekNum);
      workoutData = pData.getWorkout(weekNum, dayKey);
    } catch(e) {
      console.error('Error loading workout:', e);
    }

    const ActiveSeriesModule = (props) => {
      const {
        exercise = { name: 'EXERCICE', muscleGroup: 'MUSCLE' },
        currentSetIndex = 1,
        totalSets = 3,
        targetReps = 10,
        load = 60,
        tempo = { ecc: 3, iso: 1, con: 1 },
        instruction = '',
        restTime = 90,
        onComplete,
        onNextExercise,
        onAbort
      } = props;

      const [currentLoad, setCurrentLoad] = useState(load);
      const [currentTargetReps, setCurrentTargetReps] = useState(targetReps);
      const [currentSet, setCurrentSet] = useState(currentSetIndex);
      const [repsRemaining, setRepsRemaining] = useState(targetReps);
      const [phase, setPhase] = useState('ecc');
      const [phaseProgress, setPhaseProgress] = useState(0);
      const [isSetFinished, setIsSetFinished] = useState(false);
      const [totalTUT, setTotalTUT] = useState(0);
      const [tutHistory, setTutHistory] = useState([]);
      const [sessionVolume, setSessionVolume] = useState(0);
      const [isResting, setIsResting] = useState(false);
      const [restTimeRemaining, setRestTimeRemaining] = useState(0);
      const [breathPhase, setBreathPhase] = useState('in');
      const [breathProgress, setBreathProgress] = useState(0);
      const [selectedRPE, setSelectedRPE] = useState(null);
      const [abortProgress, setAbortProgress] = useState(0);
      const [targetLocked, setTargetLocked] = useState(false);
      const abortIntervalRef = useRef(null);
      const phaseRef = useRef('ecc');

      const ecc = tempo.ecc;
      const iso = tempo.iso;
      const con = tempo.con;

      useEffect(() => {
        const timer = setTimeout(() => setTargetLocked(true), 1000);
        return () => clearTimeout(timer);
      }, []);

      useEffect(() => {
        setCurrentLoad(load);
        setCurrentTargetReps(targetReps);
        setRepsRemaining(targetReps);
        setCurrentSet(currentSetIndex);
        setIsSetFinished(false);
        setPhase('ecc');
        phaseRef.current = 'ecc';
        setPhaseProgress(0);
        setTotalTUT(0);
      }, [load, targetReps, currentSetIndex]);

      useEffect(() => {
        if (isResting || isSetFinished) return;
        const totalRepDuration = (ecc + iso + con) * 1000;
        const eccDuration = ecc * 1000;
        const isoDuration = iso * 1000;
        
        const interval = setInterval(() => {
          setTotalTUT(prev => prev + 0.05);
          setPhaseProgress((prev) => {
            const next = prev + 50;
            let newPhase = phaseRef.current;
            
            if (next < eccDuration) {
              newPhase = 'ecc';
            } else if (next < eccDuration + isoDuration) {
              newPhase = 'iso';
            } else if (next < totalRepDuration) {
              newPhase = 'con';
            } else {
              setRepsRemaining((r) => {
                if (r - 1 <= 0) { 
                  setIsSetFinished(true); 
                  return 0; 
                }
                return r - 1;
              });
              phaseRef.current = 'ecc';
              setPhase('ecc');
              return 0;
            }
            
            if (newPhase !== phaseRef.current) {
              phaseRef.current = newPhase;
              setPhase(newPhase);
            }
            return next;
          });
        }, 50);
        return () => clearInterval(interval);
      }, [ecc, iso, con, isResting, isSetFinished]);

      useEffect(() => {
        if (!isResting) return;
        if (restTimeRemaining <= 0) { skipRest(); return; }
        const timer = setInterval(() => setRestTimeRemaining(prev => prev - 1), 1000);
        return () => clearInterval(timer);
      }, [isResting, restTimeRemaining]);

      useEffect(() => {
        if (!isResting) return;
        const interval = setInterval(() => {
          setBreathProgress(prev => {
            const next = prev + 50;
            const pos = next % 16000;
            if (pos < 4000) setBreathPhase('in');
            else if (pos < 8000) setBreathPhase('hold');
            else if (pos < 12000) setBreathPhase('out');
            else setBreathPhase('hold');
            return next;
          });
        }, 50);
        return () => clearInterval(interval);
      }, [isResting]);

      const getPhasePercentage = (p) => {
        const eccDur = ecc * 1000;
        const isoDur = iso * 1000;
        if (isSetFinished) return p === 'con' ? 100 : 0;
        if (phase !== p) return 0;
        if (phase === 'ecc') return (phaseProgress / eccDur) * 100;
        if (phase === 'iso') return ((phaseProgress - eccDur) / isoDur) * 100;
        return ((phaseProgress - eccDur - isoDur) / (con * 1000)) * 100;
      };

      const getBreathPercentage = (barType) => {
        const cyclePos = breathProgress % 16000;
        if (barType === 'left') {
          if (cyclePos < 4000) return (cyclePos / 4000) * 100;
          if (cyclePos < 8000) return 100;
          if (cyclePos < 12000) return 100 - ((cyclePos - 8000) / 4000) * 100;
          return 0;
        } else {
          if (cyclePos < 8000) return 0;
          if (cyclePos < 12000) return ((cyclePos - 8000) / 4000) * 100;
          if (cyclePos < 16000) return 100;
          return 0;
        }
      };

      const getRepProgress = () => {
        if (isSetFinished) return 1;
        const totalRepDuration = (ecc + iso + con) * 1000;
        const currentRepProgress = phaseProgress / totalRepDuration;
        const repsCompleted = currentTargetReps - repsRemaining;
        return (repsCompleted + currentRepProgress) / currentTargetReps;
      };

      const getPhaseCountdown = () => {
        const eccDur = ecc * 1000;
        const isoDur = iso * 1000;
        const conDur = con * 1000;
        if (phase === 'ecc') return Math.max(1, Math.ceil((eccDur - phaseProgress) / 1000));
        if (phase === 'iso') return Math.max(1, Math.ceil((eccDur + isoDur - phaseProgress) / 1000));
        return Math.max(1, Math.ceil((eccDur + isoDur + conDur - phaseProgress) / 1000));
      };

      const getEccFill = () => {
        if (isResting) return getBreathPercentage('left');
        if (phase === 'ecc') return getPhasePercentage('ecc');
        return 0;
      };

      const getConFill = () => {
        if (isResting) return getBreathPercentage('right');
        if (phase === 'con') return getPhasePercentage('con');
        return 0;
      };

      const getPhaseName = () => {
        if (phase === 'ecc') return 'DESCENTE';
        if (phase === 'iso') return 'MAINTIEN';
        return 'MONTÉE';
      };

      const handleValidate = () => {
        setIsSetFinished(true);
        setSessionVolume(prev => prev + currentLoad * currentTargetReps);
      };

      const handleRPESelect = (rpe) => {
        if (isResting) return;
        setSelectedRPE(rpe);
        setTimeout(() => {
          setIsResting(true);
          setRestTimeRemaining(restTime);
          setBreathProgress(0);
          if (onComplete) onComplete(rpe);
        }, 300);
      };

      const skipRest = () => {
        setTutHistory(prev => [...prev, totalTUT]);
        setIsResting(false);
        setSelectedRPE(null);
        setRepsRemaining(currentTargetReps);
        setIsSetFinished(false);
        setPhase('ecc');
        phaseRef.current = 'ecc';
        setPhaseProgress(0);
        if (currentSet >= totalSets) {
          onNextExercise && onNextExercise();
        } else {
          setCurrentSet(prev => prev + 1);
        }
        setTotalTUT(0);
      };

      const handleAbortStart = () => {
        setAbortProgress(0);
        abortIntervalRef.current = setInterval(() => {
          setAbortProgress(prev => {
            if (prev >= 100) {
              clearInterval(abortIntervalRef.current);
              onAbort && onAbort();
              return 100;
            }
            return prev + 5;
          });
        }, 50);
      };

      const handleAbortEnd = () => {
        if (abortIntervalRef.current) clearInterval(abortIntervalRef.current);
        setAbortProgress(0);
      };

      const adjustLoad = (amount) => setCurrentLoad(prev => Math.max(0, prev + amount));
      const adjustReps = (amount) => {
        const newReps = Math.max(1, currentTargetReps + amount);
        setCurrentTargetReps(newReps);
        if (!isSetFinished) setRepsRemaining(newReps);
      };
      const adjustSet = (amount) => setCurrentSet(prev => Math.max(1, Math.min(prev + amount, totalSets)));

      const muscleGroupParts = exercise.muscleGroup ? exercise.muscleGroup.split('+') : ['MUSCLE'];

      return (
        <div className="relative w-full max-w-md mx-auto h-screen bg-black text-white overflow-hidden flex flex-col font-sans select-none">
          
          <div className="absolute inset-0 overflow-hidden pointer-events-none">
            <div className={`absolute top-1/4 left-1/4 w-96 h-96 rounded-full blur-3xl animate-pulse ${isResting ? 'bg-cyan-500/20' : 'bg-cyan-500/10'}`} />
            <div className={`absolute bottom-1/4 right-1/4 w-96 h-96 rounded-full blur-3xl animate-pulse ${isResting ? 'bg-fuchsia-500/20' : 'bg-fuchsia-500/10'}`} />
          </div>

          <div className="relative z-10 flex flex-col h-full p-4">
            
            <div className="flex justify-between items-start mb-3">
              <div>
                <h1 className="text-2xl font-black tracking-tight mb-1 uppercase leading-none text-white">
                  {isResting ? 'RECOVERY' : muscleGroupParts[0].trim()}
                </h1>
                {!isResting && (
                  <div className="flex flex-wrap items-center gap-1 text-[10px] font-bold tracking-wide uppercase">
                    <span className="text-cyan-400">//</span>
                    {muscleGroupParts.map((m, i) => (
                      <React.Fragment key={i}>
                        {i > 0 && <span className="text-slate-600">+</span>}
                        <span className="text-cyan-400">{m.trim()}</span>
                      </React.Fragment>
                    ))}
                  </div>
                )}
                {isResting && (
                  <div className="flex items-center gap-2 text-xs font-bold text-cyan-400 animate-pulse">
                    <Wind size={14} />
                    <span>CYCLE 4-4-4-4</span>
                  </div>
                )}
              </div>
              
              <button 
                onMouseDown={handleAbortStart} onMouseUp={handleAbortEnd} onMouseLeave={handleAbortEnd}
                onTouchStart={handleAbortStart} onTouchEnd={handleAbortEnd}
                className="relative text-red-500 font-black text-xs tracking-wider flex items-center gap-1 bg-red-950/30 px-3 py-1.5 rounded border border-red-900/50 active:scale-95 transition-all overflow-hidden"
              >
                <div className="absolute inset-0 bg-red-600/30 transition-all duration-75" style={{ width: abortProgress + '%' }}></div>
                <span className="relative z-10">ABORT</span>
                <span className="relative z-10 text-lg leading-none">→</span>
              </button>
            </div>

            {!isResting && (
              <div className="bg-slate-900/60 backdrop-blur border border-slate-700/50 rounded-xl p-3 mb-3">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-slate-800 border border-cyan-500/30 rounded-lg flex items-center justify-center">
                      <User className="text-cyan-400" size={18} />
                    </div>
                    <div>
                      <div className="text-slate-400 text-[9px] font-bold">CIBLE</div>
                      <div className="text-cyan-400 text-sm font-black uppercase">{muscleGroupParts[0].trim()}</div>
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="text-slate-500 text-[9px] font-bold">VOLUME</div>
                    <div className="text-xl font-black text-white">{sessionVolume.toLocaleString()} <span className="text-xs text-slate-500">KG</span></div>
                  </div>
                </div>
              </div>
            )}

            <div className="flex items-center justify-between gap-3 mb-3">
              <div className="flex items-center gap-2">
                <span className="px-2 py-1 bg-cyan-500/10 border border-cyan-500/30 rounded-l text-[10px] font-black text-cyan-400">SÉRIE</span>
                <div className="px-2 py-1 bg-slate-800 border-y border-r border-slate-700 rounded-r text-[10px] font-bold text-white flex items-center gap-2">
                  <span>{currentSet} / {totalSets}</span>
                  {!isResting && (
                    <div className="flex gap-1 ml-1 border-l border-slate-600 pl-1">
                      <button onClick={() => adjustSet(-1)} className="hover:text-cyan-400"><Minus size={10}/></button>
                      <button onClick={() => adjustSet(1)} className="hover:text-cyan-400"><Plus size={10}/></button>
                    </div>
                  )}
                </div>
              </div>
              <span className={`text-[10px] font-bold flex items-center gap-1 ${targetLocked ? 'text-cyan-400' : 'text-slate-500'}`}>
                <Target size={12} className={targetLocked ? "animate-pulse" : ""} />
                TARGET LOCK
              </span>
              {!isResting && (
                <div className="flex items-center gap-1 text-[10px] font-mono text-slate-500">
                  <Timer size={10} />
                  <span>TUT: {totalTUT.toFixed(1)}s</span>
                </div>
              )}
            </div>

            {instruction && (
              <div className={`mb-3 rounded-lg border p-2 ${isResting ? 'border-cyan-500/30 bg-cyan-500/10' : 'border-yellow-500/30 bg-yellow-500/5'}`}>
                <div className="flex items-start gap-2">
                  {isResting ? <Wind size={14} className="text-cyan-400 mt-0.5"/> : <AlertTriangle size={14} className="text-yellow-500 mt-0.5" />}
                  <p className={`text-xs font-bold uppercase ${isResting ? 'text-cyan-100' : 'text-yellow-100'}`}>
                    {isResting ? 'RESPIRATION : COHÉRENCE CARDIAQUE' : instruction}
                  </p>
                </div>
              </div>
            )}

            <div className="flex-1 flex items-stretch gap-3 min-h-0">
              
              <div className="flex-none w-14 flex flex-col items-center">
                <div className={`relative w-full h-full rounded-xl border-2 overflow-hidden ${isResting && breathPhase === 'in' ? 'border-cyan-400' : 'border-slate-600'}`} style={{ background: 'linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(10,20,30,0.9))' }}>
                  <div className="absolute inset-0 pointer-events-none" style={{ 
                    backgroundImage: 'repeating-linear-gradient(0deg, transparent, transparent 10%, rgba(100,200,255,0.05) 10%, rgba(100,200,255,0.05) 10.5%)',
                    backgroundSize: '100% 10%'
                  }}></div>
                  <div 
                    className="absolute bottom-0 left-0 right-0 transition-all duration-100"
                    style={{ 
                      height: getEccFill() + '%',
                      background: 'linear-gradient(to top, #00f0ff, #6a5cff, #c084fc)'
                    }}
                  >
                    <div className="absolute inset-0 pointer-events-none" style={{ 
                      backgroundImage: 'repeating-linear-gradient(0deg, transparent, transparent 8px, rgba(0,0,0,0.3) 8px, rgba(0,0,0,0.3) 10px)',
                    }}></div>
                  </div>
                  <ArrowDown className={`absolute top-3 left-1/2 -translate-x-1/2 w-5 h-5 ${phase === 'ecc' && !isResting ? 'text-white' : 'text-cyan-400/50'}`} />
                  <ArrowUp className={`absolute bottom-3 left-1/2 -translate-x-1/2 w-5 h-5 ${isResting ? 'text-cyan-400' : 'text-cyan-400/30'}`} />
                </div>
                <span className="mt-1 text-[8px] font-black text-cyan-400">{isResting ? 'IN' : 'ECC'}</span>
              </div>

              <div className="flex-1 flex flex-col items-center justify-center min-w-0">
                
                {!isResting && (
                  <div className={`mb-2 px-3 py-1 rounded-full border text-[9px] font-black tracking-wider ${
                    phase === 'ecc' ? 'bg-cyan-500/10 border-cyan-500/50 text-cyan-400' : 
                    phase === 'iso' ? 'bg-white/10 border-white/50 text-white' : 
                    'bg-fuchsia-500/10 border-fuchsia-500/50 text-fuchsia-400'
                  }`}>
                    {phase === 'ecc' ? 'DESCENTE' : phase === 'iso' ? 'MAINTIEN' : 'MONTÉE'}
                  </div>
                )}

                <div className="relative mb-3 w-40 h-40 flex items-center justify-center">
                  <div className={`absolute inset-0 blur-[40px] rounded-full ${
                    isResting ? 'bg-slate-500/20' :
                    phase === 'ecc' ? 'bg-cyan-500/20' : phase === 'con' ? 'bg-fuchsia-500/20' : 'bg-white/10'
                  }`}></div>

                  {isResting ? (
                    <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 200 200">
                      <circle cx="100" cy="100" r="80" fill="none" stroke="rgba(148, 163, 184, 0.2)" strokeWidth="4" strokeDasharray="4 8" />
                      <circle cx="100" cy="100" r="80" fill="none" stroke="url(#gradRest)" strokeWidth="6" strokeLinecap="round"
                        strokeDasharray={2 * Math.PI * 80}
                        strokeDashoffset={(2 * Math.PI * 80) * (1 - restTimeRemaining/restTime)}
                        style={{ transition: 'stroke-dashoffset 1s linear' }}
                      />
                      <defs>
                        <linearGradient id="gradRest" x1="0%" y1="0%" x2="100%" y2="0%">
                          <stop offset="0%" stopColor="#22d3ee" />
                          <stop offset="100%" stopColor="#e879f9" />
                        </linearGradient>
                      </defs>
                    </svg>
                  ) : (
                    <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 200 200">
                      <circle cx="100" cy="100" r="80" fill="none" stroke="#1e293b" strokeWidth="4" />
                      <circle cx="100" cy="100" r="80" fill="none" 
                        stroke={phase === 'ecc' ? '#22d3ee' : phase === 'con' ? '#e879f9' : '#ffffff'} 
                        strokeWidth="4" strokeLinecap="round"
                        strokeDasharray={2 * Math.PI * 80}
                        strokeDashoffset={(2 * Math.PI * 80) * (1 - getRepProgress())}
                        style={{ transition: 'stroke-dashoffset 100ms linear, stroke 300ms ease' }}
                      />
                    </svg>
                  )}

                  <div className="relative font-black text-center leading-none" style={{ 
                    fontSize: '80px',
                    color: isResting ? '#ffffff' : phase === 'ecc' ? '#22d3ee' : phase === 'iso' ? '#ffffff' : '#e879f9'
                  }}>
                    {isResting ? restTimeRemaining : repsRemaining}
                  </div>
                  {isResting && <div className="absolute bottom-6 text-[10px] font-bold text-slate-500">SECONDES</div>}
                </div>
                
                {!isResting ? (
                  <>
                    <div className="flex justify-center gap-3 mb-2 w-full">
                      <button onClick={() => adjustReps(-1)} className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white border border-white/5"><Minus size={14}/></button>
                      <div className="flex flex-col items-center">
                        <span className="text-[10px] font-bold text-slate-500">REPS CIBLE</span>
                        <span className="text-sm font-bold text-white">{currentTargetReps}</span>
                      </div>
                      <button onClick={() => adjustReps(1)} className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white border border-white/5"><Plus size={14}/></button>
                    </div>

                    <div className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg p-2 flex justify-between items-center mb-2">
                      <button onClick={() => adjustLoad(-2.5)} className="p-1.5 hover:bg-white/10 rounded text-slate-400"><Minus size={14}/></button>
                      <div className="text-center">
                        <div className="text-[9px] font-bold text-slate-500">CHARGE</div>
                        <div className="text-xl font-black text-white">{currentLoad} <span className="text-xs text-slate-500">KG</span></div>
                      </div>
                      <button onClick={() => adjustLoad(2.5)} className="p-1.5 hover:bg-white/10 rounded text-slate-400"><Plus size={14}/></button>
                    </div>
                  </>
                ) : (
                  <div className="mb-3 text-center">
                    <div className="text-base font-black text-white mb-1">PROCHAINE SÉRIE</div>
                    <div className="text-sm font-bold text-slate-500">{Math.min(currentSet + 1, totalSets)} / {totalSets}</div>
                  </div>
                )}

                <div className="flex gap-2 w-full justify-center mb-2">
                  {!isResting ? (
                    [
                      { l: 'ECC', v: ecc, active: phase === 'ecc', c: 'cyan' },
                      { l: 'ISO', v: iso, active: phase === 'iso', c: 'white' },
                      { l: 'CON', v: con, active: phase === 'con', c: 'fuchsia' }
                    ].map((item, i) => (
                      <div key={i} className={`flex-1 bg-slate-900/80 border ${item.active ? 'border-cyan-500/50 shadow-lg' : 'border-slate-800'} rounded p-2 flex flex-col items-center`}>
                        <span className={`text-lg font-black ${item.active ? (item.c === 'cyan' ? 'text-cyan-400' : item.c === 'fuchsia' ? 'text-fuchsia-400' : 'text-white') : 'text-slate-600'}`}>{item.v}</span>
                        <span className="text-[8px] font-bold text-slate-600">{item.l}</span>
                      </div>
                    ))
                  ) : (
                    [
                      { l: 'IN', v: 4, active: breathPhase === 'in', c: 'cyan' },
                      { l: 'HOLD', v: 4, active: breathPhase === 'hold', c: 'white' },
                      { l: 'OUT', v: 4, active: breathPhase === 'out', c: 'fuchsia' }
                    ].map((item, i) => (
                      <div key={i} className={`flex-1 bg-slate-900/80 border ${item.active ? 'border-cyan-500/50 shadow-lg scale-105' : 'border-slate-800'} rounded p-2 flex flex-col items-center transition-transform`}>
                        <span className={`text-lg font-black ${item.active ? (item.c === 'cyan' ? 'text-cyan-400' : item.c === 'fuchsia' ? 'text-fuchsia-400' : 'text-white') : 'text-slate-600'}`}>{item.v}</span>
                        <span className="text-[8px] font-bold text-slate-600">{item.l}</span>
                      </div>
                    ))
                  )}
                </div>

                {!isResting && !isSetFinished && (
                  <button
                    onClick={handleValidate}
                    className="w-full py-3 mt-2 rounded-xl font-black text-lg tracking-wider bg-emerald-500 hover:bg-emerald-400 text-black shadow-[0_0_25px_rgba(16,185,129,0.4)] active:scale-[0.98] transition-all border-2 border-emerald-400"
                  >
                    VALIDER SÉRIE
                  </button>
                )}
              </div>

              <div className="flex-none w-14 flex flex-col items-center">
                <div className={`relative w-full h-full rounded-xl border-2 overflow-hidden ${isResting && breathPhase === 'out' ? 'border-fuchsia-400' : 'border-slate-600'}`} style={{ background: 'linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(20,10,30,0.9))' }}>
                  <div className="absolute inset-0 pointer-events-none" style={{ 
                    backgroundImage: 'repeating-linear-gradient(0deg, transparent, transparent 10%, rgba(200,100,255,0.05) 10%, rgba(200,100,255,0.05) 10.5%)',
                    backgroundSize: '100% 10%'
                  }}></div>
                  <div 
                    className="absolute bottom-0 left-0 right-0 transition-all duration-100"
                    style={{ 
                      height: getConFill() + '%',
                      background: 'linear-gradient(to top, #7c3aed, #c084fc, #f472b6)'
                    }}
                  >
                    <div className="absolute inset-0 pointer-events-none" style={{ 
                      backgroundImage: 'repeating-linear-gradient(0deg, transparent, transparent 8px, rgba(0,0,0,0.3) 8px, rgba(0,0,0,0.3) 10px)',
                    }}></div>
                  </div>
                  <ArrowUp className={`absolute bottom-3 left-1/2 -translate-x-1/2 w-5 h-5 ${phase === 'con' && !isResting ? 'text-white' : 'text-fuchsia-400/50'}`} />
                  <ArrowDown className={`absolute top-3 left-1/2 -translate-x-1/2 w-5 h-5 ${isResting ? 'text-fuchsia-400' : 'text-fuchsia-400/30'}`} />
                </div>
                <span className="mt-1 text-[8px] font-black text-fuchsia-400">{isResting ? 'OUT' : 'CON'}</span>
              </div>

            </div>

            {isSetFinished && !isResting && (
              <div className="mt-3 animate-slideIn">
                <div className="text-[10px] font-bold text-slate-500 text-center mb-2">ÉCHELLE RPE</div>
                <div className="flex gap-2 justify-center mb-2">
                  {[6, 7, 8, 9, 10].map((rpe) => (
                    <button
                      key={rpe}
                      onClick={() => handleRPESelect(rpe)}
                      className={`w-11 h-11 rounded-lg font-black text-lg border ${
                        selectedRPE === rpe 
                          ? 'bg-cyan-500 text-black border-cyan-400 scale-110' 
                          : 'bg-slate-800/80 text-white border-slate-700 hover:border-cyan-500/50 hover:scale-105'
                      } transition-all`}
                    >
                      {rpe}
                    </button>
                  ))}
                </div>
                <button
                  onClick={handleValidate}
                  className="w-full py-3 bg-gradient-to-r from-green-600 to-green-500 rounded-lg font-black text-base uppercase text-white shadow-lg active:scale-[0.98]"
                >
                  VALIDER SÉRIE
                </button>
              </div>
            )}

            {isResting && (
              <div className="mt-3 animate-slideIn">
                <button
                  onClick={skipRest}
                  className="w-full py-3 bg-gradient-to-r from-cyan-600 to-fuchsia-600 rounded-lg font-black text-base uppercase text-white shadow-lg flex items-center justify-center gap-2 active:scale-[0.98]"
                >
                  <SkipForward size={18} />
                  SKIP REPOS
                </button>
              </div>
            )}

          </div>
        </div>
      );
    };

    const SessionPage = () => {
      const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
      const startTimeRef = useRef(Date.now());
      
      const exercises = workoutData?.exercises || [
        { name: 'Exercice Demo', sets: 3, reps: '10', notes: '', muscles: ['demo'] }
      ];

      const currentExercise = exercises[currentExerciseIndex];
      const tempo = weekData?.tempo || { ecc: 3, iso: 1, con: 2 };
      const rest = weekData?.rest || 90;

      const handleExerciseComplete = () => {
        if (currentExerciseIndex < exercises.length - 1) {
          setCurrentExerciseIndex(prev => prev + 1);
        } else {
          const duration = Math.round((Date.now() - startTimeRef.current) / 60000);
          const stats = {
            name: workoutData?.name || 'Session',
            duration: duration,
            week: weekNum,
            day: dayKey,
            exercises: exercises.length,
            completedAt: new Date().toISOString()
          };
          localStorage.setItem('last_session_data', JSON.stringify(stats));
          
          const xp = parseInt(localStorage.getItem('hybrid_xp') || '0');
          localStorage.setItem('hybrid_xp', String(xp + 100));
          
          window.location.href = 'debrief.html';
        }
      };

      const handleAbort = () => {
        if (confirm('Abandonner la session ?')) {
          window.location.href = 'index.html';
        }
      };

      return (
        <ActiveSeriesModule
          exercise={{ 
            name: currentExercise.name, 
            muscleGroup: workoutData?.name || 'ENTRAINEMENT'
          }}
          currentSetIndex={1}
          totalSets={currentExercise.sets || 3}
          targetReps={parseInt(currentExercise.reps) || 10}
          load={60}
          tempo={tempo}
          instruction={currentExercise.notes || ''}
          restTime={rest}
          onComplete={(rpe) => console.log('Set complete RPE:', rpe)}
          onNextExercise={handleExerciseComplete}
          onAbort={handleAbort}
        />
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<SessionPage />);
  </script>
</body>
</html>
