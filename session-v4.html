<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>NEON FIT V4 // MODE COMBAT</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            void: '#020408',
            'void-soft': '#0a0f14',
            cyan: '#22d3ee',
            magenta: '#c084fc',
            amber: '#f59e0b',
            lime: '#84cc16',
            purple: '#a855f7',
            emerald: '#10b981'
          }
        }
      }
    }
  </script>
  
  <style>
    :root {
      --cyan: #22d3ee;
      --magenta: #c084fc;
      --amber: #f59e0b;
      --lime: #84cc16;
      --purple: #a855f7;
      --emerald: #10b981;
      --void: #020408;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
      background: var(--void);
    }
    
    body {
      font-family: 'Inter', sans-serif;
      color: white;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      padding-top: env(safe-area-inset-top);
      touch-action: manipulation;
      position: fixed;
      inset: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    .font-display { font-family: 'Orbitron', sans-serif; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    
    .counter-giant {
      font-size: clamp(80px, 25vw, 140px);
      font-weight: 900;
      line-height: 1;
      text-shadow: 0 0 60px rgba(34, 211, 238, 0.5);
    }
    
    .tempo-bar {
      width: 24px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      overflow: hidden;
      position: relative;
    }
    
    .tempo-bar-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      border-radius: 12px;
    }
    
    .tempo-bar-descent .tempo-bar-fill {
      background: linear-gradient(to top, var(--cyan), transparent);
      box-shadow: 0 0 20px var(--cyan);
    }
    
    .tempo-bar-lift .tempo-bar-fill {
      background: linear-gradient(to top, var(--amber), transparent);
      box-shadow: 0 0 20px var(--amber);
    }
    
    .btn-validate {
      min-height: 80px;
      background: linear-gradient(135deg, var(--cyan), #06b6d4);
      border-radius: 20px;
      font-weight: 800;
      font-size: 20px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      box-shadow: 0 0 40px rgba(34, 211, 238, 0.4), 0 8px 32px rgba(0, 0, 0, 0.4);
      -webkit-transition: -webkit-transform 0.1s, box-shadow 0.1s;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    
    .btn-validate:active {
      -webkit-transform: scale(0.97);
      transform: scale(0.97);
      box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);
    }
    
    .btn-weight {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      font-size: 28px;
      font-weight: 700;
      -webkit-transition: background 0.1s, -webkit-transform 0.1s;
      transition: background 0.1s, transform 0.1s;
    }
    
    .btn-weight:active {
      background: rgba(255,255,255,0.15);
      -webkit-transform: scale(0.95);
      transform: scale(0.95);
    }
    
    .glass-panel {
      background: rgba(10, 15, 20, 0.9);
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 24px;
    }
    
    .btn-intensity {
      background: linear-gradient(135deg, rgba(192, 132, 252, 0.2), rgba(192, 132, 252, 0.05));
      border: 1px solid rgba(192, 132, 252, 0.3);
      border-radius: 16px;
      padding: 16px 24px;
      -webkit-transition: all 0.2s;
      transition: all 0.2s;
    }
    
    .btn-intensity:active {
      background: rgba(192, 132, 252, 0.3);
      -webkit-transform: scale(0.98);
      transform: scale(0.98);
    }
    
    .btn-preset {
      padding: 12px 20px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      font-weight: 600;
      -webkit-transition: all 0.15s;
      transition: all 0.15s;
    }
    
    .btn-preset:active, .btn-preset.active {
      background: rgba(34, 211, 238, 0.2);
      border-color: rgba(34, 211, 238, 0.5);
      color: var(--cyan);
    }
    
    .optimal-window {
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(90deg, 
        rgba(239, 68, 68, 0.3) 0%, 
        rgba(34, 211, 238, 0.8) 30%, 
        rgba(16, 185, 129, 1) 50%, 
        rgba(34, 211, 238, 0.8) 70%, 
        rgba(249, 115, 22, 0.5) 100%
      );
      position: relative;
    }
    
    .optimal-marker {
      position: absolute;
      top: -4px;
      width: 4px;
      height: 16px;
      background: white;
      border-radius: 2px;
      box-shadow: 0 0 10px white;
    }
    
    .rest-circle {
      stroke-linecap: round;
      -webkit-transform: rotate(-90deg);
      transform: rotate(-90deg);
      -webkit-transform-origin: center;
      transform-origin: center;
    }
    
    @-webkit-keyframes xp-toast {
      0% { opacity: 0; -webkit-transform: translateX(-50%) translateY(-30px); }
      15% { opacity: 1; -webkit-transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; -webkit-transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; -webkit-transform: translateX(-50%) translateY(-20px); }
    }
    @keyframes xp-toast {
      0% { opacity: 0; transform: translateX(-50%) translateY(-30px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }
    
    .xp-toast {
      -webkit-animation: xp-toast 2s ease-out forwards;
      animation: xp-toast 2s ease-out forwards;
    }
    
    @-webkit-keyframes particle-burst {
      0% { opacity: 1; -webkit-transform: scale(0); }
      100% { opacity: 0; -webkit-transform: scale(1); }
    }
    @keyframes particle-burst {
      0% { opacity: 1; transform: scale(0); }
      100% { opacity: 0; transform: scale(1); }
    }
    
    .particle-ring {
      position: absolute;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      border: 3px solid var(--cyan);
      -webkit-animation: particle-burst 0.6s ease-out forwards;
      animation: particle-burst 0.6s ease-out forwards;
    }
    
    .flash-screen {
      position: fixed;
      inset: 0;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 100;
    }
    
    @-webkit-keyframes flash {
      0% { opacity: 0.3; }
      100% { opacity: 0; }
    }
    @keyframes flash {
      0% { opacity: 0.3; }
      100% { opacity: 0; }
    }
    
    .flash-screen.flash {
      -webkit-animation: flash 0.15s ease-out;
      animation: flash 0.15s ease-out;
    }
    
    .coaching-text {
      font-style: italic;
      color: rgba(255,255,255,0.6);
      font-size: 14px;
    }
    
    .hidden { display: none !important; }
    
    .swipe-hint {
      font-size: 11px;
      color: rgba(255,255,255,0.3);
    }
    
    .rir-slider { display: flex; gap: 8px; }
    
    .rir-option {
      flex: 1;
      padding: 16px 8px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 2px solid transparent;
      text-align: center;
      -webkit-transition: all 0.15s;
      transition: all 0.15s;
    }
    
    .rir-option:active, .rir-option.active {
      border-color: var(--cyan);
      background: rgba(34, 211, 238, 0.1);
    }
    
    .rir-option.active .rir-value { color: var(--cyan); }
    
    .tag-btn {
      padding: 8px 14px;
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      font-size: 12px;
      font-weight: 600;
      -webkit-transition: all 0.15s;
      transition: all 0.15s;
    }
    
    .tag-btn:active, .tag-btn.active {
      background: rgba(34, 211, 238, 0.15);
      border-color: rgba(34, 211, 238, 0.4);
      color: var(--cyan);
    }
    
    .score-bar {
      height: 6px;
      border-radius: 3px;
      background: rgba(255,255,255,0.1);
      overflow: hidden;
    }
    
    .score-bar-fill {
      height: 100%;
      border-radius: 3px;
    }
  </style>
</head>

<body>
  
  <div id="flash-screen" class="flash-screen"></div>
  
  <div id="xp-toast" class="fixed top-20 left-1/2 z-50 opacity-0 pointer-events-none" style="-webkit-transform: translateX(-50%); transform: translateX(-50%);">
    <div class="flex items-center gap-3 px-5 py-3 rounded-2xl bg-black/90 border border-cyan/40" style="-webkit-backdrop-filter: blur(20px); backdrop-filter: blur(20px); box-shadow: 0 0 40px rgba(34,211,238,0.4);">
      <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan to-magenta flex items-center justify-center">
        <span class="text-2xl">‚ö°</span>
      </div>
      <div>
        <div id="xp-amount" class="text-2xl font-black font-display text-transparent bg-clip-text bg-gradient-to-r from-cyan to-magenta" style="-webkit-background-clip: text;">+50 XP</div>
        <div class="text-xs font-bold text-white/50 uppercase tracking-widest">Serie validee</div>
      </div>
    </div>
  </div>
  
  <div id="particle-container" class="fixed inset-0 pointer-events-none z-40 flex items-center justify-center"></div>

  <!-- MODE SERIE -->
  <div id="mode-serie" class="flex-1 flex flex-col">
    
    <header class="px-4 py-3 flex items-center justify-between">
      <button id="btn-back" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center">
        <span class="text-white/60">‚Üê</span>
      </button>
      <div class="text-center">
        <div class="text-xs font-bold text-white/40 uppercase tracking-widest">Mission en cours</div>
        <div id="workout-name" class="font-display font-bold text-sm text-white">DOS + JAMBES</div>
      </div>
      <button id="btn-focus" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center">
        <span class="text-white/60">‚óâ</span>
      </button>
    </header>
    
    <div class="px-4 py-2">
      <div class="glass-panel px-4 py-3">
        <div class="flex items-center justify-between">
          <div>
            <div id="exercise-name" class="font-display font-bold text-lg text-white">Trap Bar Deadlift</div>
            <div class="flex items-center gap-2 mt-1">
              <span id="muscle-tag" class="px-2 py-0.5 rounded text-xs font-bold uppercase bg-cyan/20 text-cyan border border-cyan/30">DOS</span>
              <span id="set-info" class="text-sm text-white/50">Serie <span id="current-set">1</span>/<span id="total-sets">5</span></span>
              <span class="text-white/30">‚Ä¢</span>
              <span id="tempo-info" class="text-sm text-white/50">Tempo 3-1-2</span>
            </div>
          </div>
          <div class="text-right">
            <div id="weight-display" class="font-mono font-bold text-2xl text-white">75<span class="text-sm text-white/50">kg</span></div>
          </div>
        </div>
        <div id="exercise-notes" class="mt-2 text-xs text-white/40 italic"></div>
      </div>
    </div>
    
    <div class="flex-1 flex items-center justify-center px-4 relative">
      
      <div class="tempo-bar tempo-bar-descent h-48 mr-6">
        <div id="tempo-descent" class="tempo-bar-fill" style="height: 0%;"></div>
        <div class="absolute -bottom-6 left-1/2 text-[10px] font-bold text-cyan/60 uppercase" style="-webkit-transform: translateX(-50%); transform: translateX(-50%);">DESC</div>
      </div>
      
      <div class="text-center">
        <div class="text-xs font-bold text-white/30 uppercase tracking-widest mb-2">Repetitions</div>
        <div id="rep-counter" class="counter-giant font-mono text-cyan">0</div>
        <div class="text-sm text-white/40 mt-2">sur <span id="target-reps">6-8</span></div>
        <div id="coaching-text" class="coaching-text mt-4 max-w-[200px] mx-auto">"Controle bas, explosion propre"</div>
      </div>
      
      <div class="tempo-bar tempo-bar-lift h-48 ml-6">
        <div id="tempo-lift" class="tempo-bar-fill" style="height: 0%;"></div>
        <div class="absolute -bottom-6 left-1/2 text-[10px] font-bold text-amber/60 uppercase" style="-webkit-transform: translateX(-50%); transform: translateX(-50%);">LIFT</div>
      </div>
      
    </div>
    
    <div class="px-4 pb-4" style="padding-bottom: calc(env(safe-area-inset-bottom) + 16px);">
      
      <div class="flex items-center justify-center gap-6 mb-4">
        <button id="btn-rep-minus" class="btn-weight text-white/60">‚àí</button>
        <div class="text-center">
          <div class="text-xs font-bold text-white/30 uppercase">Reps</div>
        </div>
        <button id="btn-rep-plus" class="btn-weight text-white/60">+</button>
      </div>
      
      <div class="flex items-center justify-between mb-4">
        <button id="btn-weight-minus" class="btn-weight text-white/60">‚àí</button>
        <div class="text-center">
          <div class="text-xs font-bold text-white/30 uppercase mb-1">Charge</div>
          <div id="weight-adjust-display" class="font-mono font-bold text-xl text-white">75 kg</div>
        </div>
        <button id="btn-weight-plus" class="btn-weight text-white/60">+</button>
      </div>
      
      <button id="btn-validate" class="btn-validate w-full text-black font-display">‚úì VALIDER SERIE</button>
      
      <div class="swipe-hint text-center mt-3">‚Üê Swipe gauche : Echec technique</div>
      
    </div>
    
  </div>

  <!-- MODE REPOS -->
  <div id="mode-repos" class="fixed inset-0 bg-void z-30 hidden flex-col">
    
    <header class="px-4 py-3 flex items-center justify-between" style="padding-top: env(safe-area-inset-top);">
      <div class="text-xs font-bold text-amber/60 uppercase tracking-widest">Repos</div>
      <button id="btn-skip-rest" class="px-4 py-2 rounded-lg bg-white/5 text-xs font-bold text-white/50 uppercase">Skip ‚Üí</button>
    </header>
    
    <div class="flex-1 flex flex-col items-center justify-center px-4">
      
      <div class="relative w-64 h-64">
        <svg class="w-full h-full" viewBox="0 0 256 256">
          <defs>
            <linearGradient id="rest-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#22d3ee"/>
              <stop offset="50%" stop-color="#10b981"/>
              <stop offset="100%" stop-color="#f59e0b"/>
            </linearGradient>
          </defs>
          <circle cx="128" cy="128" r="110" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="12"/>
          <circle id="rest-progress" cx="128" cy="128" r="110" fill="none" 
                  stroke="url(#rest-gradient)" stroke-width="12" 
                  stroke-dasharray="691" stroke-dashoffset="0"
                  class="rest-circle"/>
        </svg>
        
        <div class="absolute inset-0 flex flex-col items-center justify-center">
          <div id="rest-timer" class="font-mono font-black text-6xl text-white">2:00</div>
          <div class="text-sm text-white/40 mt-1">/ <span id="rest-total">2:00</span></div>
        </div>
      </div>
      
      <div class="w-full max-w-xs mt-8">
        <div class="flex justify-between text-xs text-white/40 mb-2">
          <span>Trop court</span>
          <span class="text-emerald font-bold">Zone optimale</span>
          <span>Trop long</span>
        </div>
        <div class="optimal-window">
          <div id="optimal-marker" class="optimal-marker" style="left: 50%;"></div>
        </div>
      </div>
      
      <div class="flex gap-3 mt-6">
        <button class="btn-preset" data-time="30">30s</button>
        <button class="btn-preset" data-time="60">60s</button>
        <button class="btn-preset active" data-time="90">90s</button>
        <button class="btn-preset" data-time="120">120s</button>
      </div>
      
      <div class="glass-panel w-full max-w-xs mt-6 px-4 py-3">
        <div class="text-xs font-bold text-white/40 uppercase mb-1">Prochain</div>
        <div class="flex items-center justify-between">
          <div>
            <div id="next-exercise" class="font-display font-bold text-white">Rowing Haltere</div>
            <div class="text-sm text-white/50"><span id="next-sets">4</span>√ó<span id="next-reps">8-10</span> ‚Ä¢ <span id="next-weight">32</span>kg</div>
          </div>
          <span id="next-muscle-tag" class="px-2 py-0.5 rounded text-xs font-bold uppercase bg-cyan/20 text-cyan border border-cyan/30">DOS</span>
        </div>
      </div>
      
      <button id="btn-intensify" class="btn-intensity w-full max-w-xs mt-4 flex items-center justify-center gap-3">
        <span class="text-xl">‚ö°</span>
        <span class="font-display font-bold text-magenta uppercase">Intensification</span>
      </button>
      
      <div id="rest-coaching" class="coaching-text text-center mt-4 max-w-xs">"Relache trapezes. Respire. Repars a 90s."</div>
      
    </div>
    
  </div>

  <!-- MODE INTENSIFICATION -->
  <div id="mode-intensification" class="fixed inset-0 bg-void/95 z-40 hidden flex-col">
    
    <header class="px-4 py-4 flex items-center justify-between" style="padding-top: calc(env(safe-area-inset-top) + 8px);">
      <button id="btn-close-intensify" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center">
        <span class="text-white/60">‚Üê</span>
      </button>
      <div class="font-display font-bold text-magenta uppercase">Intensification</div>
      <div class="w-10"></div>
    </header>
    
    <div class="flex-1 overflow-y-auto px-4 pb-8">
      
      <div class="glass-panel p-4 mb-4" id="intensity-dropset">
        <div class="flex items-center gap-3 mb-2">
          <span class="text-2xl">üíß</span>
          <div>
            <div class="font-display font-bold text-white">DROP SET</div>
            <div class="text-sm text-white/50">Reduit charge 20%, continue</div>
          </div>
        </div>
        <div class="text-xs text-white/40 mb-3">Serie ‚Üí 10s repos ‚Üí -20% charge ‚Üí Echec</div>
        <button class="w-full py-3 rounded-xl bg-gradient-to-r from-cyan/20 to-magenta/20 border border-white/10 font-bold text-white uppercase text-sm intensity-activate" data-technique="drop-set">Activer Drop Set</button>
      </div>
      
      <div class="glass-panel p-4 mb-4" id="intensity-restpause">
        <div class="flex items-center gap-3 mb-2">
          <span class="text-2xl">‚è∏Ô∏è</span>
          <div>
            <div class="font-display font-bold text-white">REST-PAUSE</div>
            <div class="text-sm text-white/50">20s repos ‚Üí 3-5 reps ‚Üí iso</div>
          </div>
        </div>
        <div class="text-xs text-white/40 mb-3">Serie ‚Üí 20s ‚Üí 3-5 reps ‚Üí 10s iso-hold</div>
        <button class="w-full py-3 rounded-xl bg-gradient-to-r from-cyan/20 to-magenta/20 border border-white/10 font-bold text-white uppercase text-sm intensity-activate" data-technique="rest-pause">Activer Rest-Pause</button>
      </div>
      
      <div class="glass-panel p-4 mb-4" id="intensity-myoreps">
        <div class="flex items-center gap-3 mb-2">
          <span class="text-2xl">üîÑ</span>
          <div>
            <div class="font-display font-bold text-white">MYO-REPS</div>
            <div class="text-sm text-white/50">Serie activatrice + minis</div>
          </div>
        </div>
        <div class="text-xs text-white/40 mb-3">12-15 reps ‚Üí 5s ‚Üí 5 reps √ó 3-4</div>
        <button class="w-full py-3 rounded-xl bg-gradient-to-r from-cyan/20 to-magenta/20 border border-white/10 font-bold text-white uppercase text-sm intensity-activate" data-technique="myo-reps">Activer Myo-Reps</button>
      </div>
      
      <div class="glass-panel p-4 mb-4" id="intensity-isohold">
        <div class="flex items-center gap-3 mb-2">
          <span class="text-2xl">üîí</span>
          <div>
            <div class="font-display font-bold text-white">ISO-HOLD FIN</div>
            <div class="text-sm text-white/50">Maintien isometrique 8-10s</div>
          </div>
        </div>
        <div class="text-xs text-white/40 mb-3">Derniere rep ‚Üí Hold position basse/haute</div>
        <button class="w-full py-3 rounded-xl bg-gradient-to-r from-cyan/20 to-magenta/20 border border-white/10 font-bold text-white uppercase text-sm intensity-activate" data-technique="iso-hold">Activer Iso-Hold</button>
      </div>
      
    </div>
    
  </div>

  <!-- MODE RPE/RIR -->
  <div id="mode-rpe" class="fixed inset-0 bg-void/95 z-40 hidden flex-col">
    
    <header class="px-4 py-4" style="padding-top: calc(env(safe-area-inset-top) + 8px);">
      <div class="text-center">
        <div class="text-xs font-bold text-white/40 uppercase tracking-widest">Evaluation Serie</div>
        <div class="font-display font-bold text-white mt-1">Serie <span id="rpe-set">1</span>/<span id="rpe-total-sets">5</span> ‚Ä¢ <span id="rpe-weight">75</span>kg ‚Ä¢ <span id="rpe-reps">6</span> reps</div>
      </div>
    </header>
    
    <div class="flex-1 px-4 pb-8 overflow-y-auto">
      
      <div class="mb-6">
        <div class="text-xs font-bold text-white/50 uppercase tracking-widest mb-3">Reps en Reserve (RIR)</div>
        <div class="rir-slider">
          <button class="rir-option" data-rir="3">
            <div class="rir-value font-mono font-bold text-xl text-white">3+</div>
            <div class="text-xs text-white/40 mt-1">Easy</div>
          </button>
          <button class="rir-option active" data-rir="2">
            <div class="rir-value font-mono font-bold text-xl text-cyan">2</div>
            <div class="text-xs text-white/40 mt-1">Good</div>
          </button>
          <button class="rir-option" data-rir="1">
            <div class="rir-value font-mono font-bold text-xl text-white">1</div>
            <div class="text-xs text-white/40 mt-1">Hard</div>
          </button>
          <button class="rir-option" data-rir="0">
            <div class="rir-value font-mono font-bold text-xl text-white">0</div>
            <div class="text-xs text-white/40 mt-1">Fail</div>
          </button>
        </div>
      </div>
      
      <div class="glass-panel p-4 mb-6">
        <div class="text-xs font-bold text-white/50 uppercase tracking-widest mb-3">Score Technique</div>
        <div class="space-y-3">
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-white/60">Tempo</span>
              <span id="score-tempo" class="font-mono text-cyan">85%</span>
            </div>
            <div class="score-bar">
              <div id="score-tempo-bar" class="score-bar-fill bg-gradient-to-r from-cyan to-emerald" style="width: 85%;"></div>
            </div>
          </div>
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-white/60">Range</span>
              <span id="score-range" class="font-mono text-emerald">100%</span>
            </div>
            <div class="score-bar">
              <div id="score-range-bar" class="score-bar-fill bg-emerald" style="width: 100%;"></div>
            </div>
          </div>
          <div class="pt-2 border-t border-white/10">
            <div class="flex justify-between items-center">
              <span class="font-bold text-white">Score Global</span>
              <div class="flex items-center gap-2">
                <span id="score-global" class="font-mono font-bold text-2xl text-cyan">92</span>
                <span class="text-white/40">/100</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="mb-6">
        <div class="text-xs font-bold text-white/50 uppercase tracking-widest mb-3">Tags Rapides</div>
        <div class="flex flex-wrap gap-2">
          <button class="tag-btn" data-tag="grip-large">Grip large</button>
          <button class="tag-btn" data-tag="tempo-plus">Tempo +1s</button>
          <button class="tag-btn" data-tag="pec-dominant">Pec dominant</button>
          <button class="tag-btn" data-tag="epaule-ok">Epaule OK</button>
          <button class="tag-btn" data-tag="range-reduit">Range reduit</button>
          <button class="tag-btn" data-tag="form-drift">Form drift</button>
        </div>
      </div>
      
      <button id="btn-rpe-continue" class="btn-validate w-full text-black font-display">SUIVANT ‚Üí</button>
      
    </div>
    
  </div>

  <!-- SCRIPTS -->
  <script src="program-data.js"></script>
  <script src="gamification-v4.js"></script>
  
  <script>
    (function() {
      'use strict';
      
      // ========== STORAGE KEYS ==========
      var STORAGE = {
        history: 'neon_fit_workout_history',
        xp: 'hybrid_xp',
        week: 'hybrid_current_week',
        lastSession: 'neon_fit_v4_last_session'
      };
      
      // ========== STATE ==========
      var state = {
        week: 1,
        day: 'dimanche',
        currentExerciseIndex: 0,
        currentSet: 1,
        currentReps: 0,
        currentWeight: 0,
        restTime: 90,
        restRemaining: 0,
        isResting: false,
        restInterval: null,
        selectedRIR: 2,
        selectedTags: [],
        activeTechnique: null,
        exercises: [],
        workoutData: null,
        sessionVolume: 0,
        sessionStartTime: null
      };
      
      // ========== DOM ELEMENTS ==========
      var el = {};
      
      function cacheDOMElements() {
        el.modeSerie = document.getElementById('mode-serie');
        el.modeRepos = document.getElementById('mode-repos');
        el.modeIntensification = document.getElementById('mode-intensification');
        el.modeRpe = document.getElementById('mode-rpe');
        el.exerciseName = document.getElementById('exercise-name');
        el.muscleTag = document.getElementById('muscle-tag');
        el.currentSet = document.getElementById('current-set');
        el.totalSets = document.getElementById('total-sets');
        el.tempoInfo = document.getElementById('tempo-info');
        el.weightDisplay = document.getElementById('weight-display');
        el.weightAdjustDisplay = document.getElementById('weight-adjust-display');
        el.repCounter = document.getElementById('rep-counter');
        el.targetReps = document.getElementById('target-reps');
        el.coachingText = document.getElementById('coaching-text');
        el.exerciseNotes = document.getElementById('exercise-notes');
        el.restTimer = document.getElementById('rest-timer');
        el.restTotal = document.getElementById('rest-total');
        el.restProgress = document.getElementById('rest-progress');
        el.optimalMarker = document.getElementById('optimal-marker');
        el.xpToast = document.getElementById('xp-toast');
        el.xpAmount = document.getElementById('xp-amount');
        el.flashScreen = document.getElementById('flash-screen');
        el.particleContainer = document.getElementById('particle-container');
        el.tempoDescent = document.getElementById('tempo-descent');
        el.tempoLift = document.getElementById('tempo-lift');
        el.workoutName = document.getElementById('workout-name');
        el.nextExercise = document.getElementById('next-exercise');
        el.nextSets = document.getElementById('next-sets');
        el.nextReps = document.getElementById('next-reps');
        el.nextWeight = document.getElementById('next-weight');
        el.nextMuscleTag = document.getElementById('next-muscle-tag');
      }
      
      // ========== MUSCLE COLORS ==========
      var muscleColors = {
        'dos': { bg: 'bg-cyan/20', text: 'text-cyan', border: 'border-cyan/30' },
        'pectoraux': { bg: 'bg-magenta/20', text: 'text-magenta', border: 'border-magenta/30' },
        'pecs': { bg: 'bg-magenta/20', text: 'text-magenta', border: 'border-magenta/30' },
        'jambes': { bg: 'bg-lime/20', text: 'text-lime', border: 'border-lime/30' },
        'quadriceps': { bg: 'bg-lime/20', text: 'text-lime', border: 'border-lime/30' },
        'fessiers': { bg: 'bg-lime/20', text: 'text-lime', border: 'border-lime/30' },
        'epaules': { bg: 'bg-amber/20', text: 'text-amber', border: 'border-amber/30' },
        'bras': { bg: 'bg-purple/20', text: 'text-purple', border: 'border-purple/30' },
        'biceps': { bg: 'bg-purple/20', text: 'text-purple', border: 'border-purple/30' },
        'triceps': { bg: 'bg-purple/20', text: 'text-purple', border: 'border-purple/30' },
        'abdos': { bg: 'bg-emerald/20', text: 'text-emerald', border: 'border-emerald/30' }
      };
      
      function getMuscleStyle(muscle) {
        var m = (muscle || 'dos').toLowerCase();
        return muscleColors[m] || muscleColors['dos'];
      }
      
      // ========== COACHING MESSAGES ==========
      var coachingMessages = [
        '"Controle bas, explosion propre"',
        '"Lock les omoplates, respire"',
        '"Excentrique lent, concentrique explosif"',
        '"Une rep en reserve"',
        '"Reste serre, pas de rebond"',
        '"Controle total sur chaque phase"'
      ];
      
      // ========== INIT ==========
      function init() {
        cacheDOMElements();
        loadWorkoutData();
        setupEventListeners();
        state.sessionStartTime = new Date();
        console.log('Session V4 initialized', state);
      }
      
      function loadWorkoutData() {
        var urlParams = new URLSearchParams(window.location.search);
        state.week = parseInt(urlParams.get('week')) || parseInt(localStorage.getItem(STORAGE.week)) || 1;
        state.day = urlParams.get('day') || 'dimanche';
        
        if (window.programData && window.programData.program) {
          var weekKey = 'week' + state.week;
          var weekData = window.programData.program[weekKey];
          
          if (weekData && weekData[state.day]) {
            state.workoutData = weekData[state.day];
            state.exercises = weekData[state.day].exercises || [];
            el.workoutName.textContent = weekData[state.day].name || state.day.toUpperCase();
            console.log('Loaded workout:', state.workoutData.name, 'with', state.exercises.length, 'exercises');
          } else {
            console.warn('No workout data for week', state.week, state.day);
          }
        } else {
          console.warn('programData not available');
        }
        
        if (state.exercises.length > 0) {
          loadExercise(0);
        }
      }
      
      function loadExercise(index) {
        if (index >= state.exercises.length) {
          finishWorkout();
          return;
        }
        
        var exercise = state.exercises[index];
        state.currentExerciseIndex = index;
        state.currentSet = 1;
        state.currentReps = 0;
        state.currentWeight = exercise.weight || 0;
        state.restTime = exercise.rest || 90;
        state.activeTechnique = null;
        
        updateUI();
      }
      
      function updateUI() {
        var exercise = state.exercises[state.currentExerciseIndex];
        if (!exercise) return;
        
        el.exerciseName.textContent = exercise.name;
        el.currentSet.textContent = state.currentSet;
        el.totalSets.textContent = exercise.sets;
        el.tempoInfo.textContent = 'Tempo ' + (exercise.tempo || '3-1-2');
        el.weightDisplay.innerHTML = state.currentWeight + '<span class="text-sm text-white/50">kg</span>';
        el.weightAdjustDisplay.textContent = state.currentWeight + ' kg';
        el.repCounter.textContent = state.currentReps;
        el.targetReps.textContent = exercise.reps;
        
        if (exercise.notes) {
          el.exerciseNotes.textContent = exercise.notes;
          el.exerciseNotes.style.display = 'block';
        } else {
          el.exerciseNotes.style.display = 'none';
        }
        
        var muscles = exercise.muscle || ['dos'];
        var mainMuscle = muscles[0];
        var style = getMuscleStyle(mainMuscle);
        
        el.muscleTag.className = 'px-2 py-0.5 rounded text-xs font-bold uppercase ' + style.bg + ' ' + style.text + ' border ' + style.border;
        el.muscleTag.textContent = mainMuscle.toUpperCase();
        
        el.coachingText.textContent = coachingMessages[Math.floor(Math.random() * coachingMessages.length)];
        
        updateNextExercisePreview();
      }
      
      function updateNextExercisePreview() {
        var nextExercise = null;
        var exercise = state.exercises[state.currentExerciseIndex];
        
        if (state.currentSet < exercise.sets) {
          nextExercise = exercise;
          el.nextExercise.textContent = exercise.name + ' (Serie ' + (state.currentSet + 1) + ')';
        } else if (state.currentExerciseIndex + 1 < state.exercises.length) {
          nextExercise = state.exercises[state.currentExerciseIndex + 1];
          el.nextExercise.textContent = nextExercise.name;
        } else {
          el.nextExercise.textContent = 'Fin de session';
          el.nextSets.textContent = '-';
          el.nextReps.textContent = '-';
          el.nextWeight.textContent = '-';
          return;
        }
        
        if (nextExercise) {
          el.nextSets.textContent = nextExercise.sets;
          el.nextReps.textContent = nextExercise.reps;
          el.nextWeight.textContent = nextExercise.weight || 0;
          
          var muscles = nextExercise.muscle || ['dos'];
          var style = getMuscleStyle(muscles[0]);
          el.nextMuscleTag.className = 'px-2 py-0.5 rounded text-xs font-bold uppercase ' + style.bg + ' ' + style.text + ' border ' + style.border;
          el.nextMuscleTag.textContent = muscles[0].toUpperCase();
        }
      }
      
      // ========== EVENT LISTENERS ==========
      function setupEventListeners() {
        document.getElementById('btn-rep-minus').addEventListener('click', function() {
          if (state.currentReps > 0) {
            state.currentReps--;
            el.repCounter.textContent = state.currentReps;
          }
        });
        
        document.getElementById('btn-rep-plus').addEventListener('click', function() {
          state.currentReps++;
          el.repCounter.textContent = state.currentReps;
          animateTempoBars();
        });
        
        document.getElementById('btn-weight-minus').addEventListener('click', function() {
          state.currentWeight = Math.max(0, state.currentWeight - 2.5);
          el.weightDisplay.innerHTML = state.currentWeight + '<span class="text-sm text-white/50">kg</span>';
          el.weightAdjustDisplay.textContent = state.currentWeight + ' kg';
        });
        
        document.getElementById('btn-weight-plus').addEventListener('click', function() {
          state.currentWeight += 2.5;
          el.weightDisplay.innerHTML = state.currentWeight + '<span class="text-sm text-white/50">kg</span>';
          el.weightAdjustDisplay.textContent = state.currentWeight + ' kg';
        });
        
        document.getElementById('btn-validate').addEventListener('click', validateSet);
        
        document.getElementById('btn-skip-rest').addEventListener('click', endRest);
        
        document.getElementById('btn-intensify').addEventListener('click', function() {
          el.modeIntensification.classList.remove('hidden');
          el.modeIntensification.classList.add('flex');
        });
        
        document.getElementById('btn-close-intensify').addEventListener('click', function() {
          el.modeIntensification.classList.add('hidden');
          el.modeIntensification.classList.remove('flex');
        });
        
        document.getElementById('btn-rpe-continue').addEventListener('click', function() {
          el.modeRpe.classList.add('hidden');
          el.modeRpe.classList.remove('flex');
          startRest();
        });
        
        document.querySelectorAll('.rir-option').forEach(function(btn) {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.rir-option').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            state.selectedRIR = parseInt(btn.getAttribute('data-rir'));
          });
        });
        
        document.querySelectorAll('.btn-preset').forEach(function(btn) {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.btn-preset').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            var newTime = parseInt(btn.getAttribute('data-time'));
            state.restTime = newTime;
            state.restRemaining = newTime;
            updateRestDisplay();
          });
        });
        
        document.querySelectorAll('.tag-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            btn.classList.toggle('active');
            var tag = btn.getAttribute('data-tag');
            var idx = state.selectedTags.indexOf(tag);
            if (idx === -1) {
              state.selectedTags.push(tag);
            } else {
              state.selectedTags.splice(idx, 1);
            }
          });
        });
        
        document.querySelectorAll('.intensity-activate').forEach(function(btn) {
          btn.addEventListener('click', function() {
            state.activeTechnique = btn.getAttribute('data-technique');
            el.modeIntensification.classList.add('hidden');
            el.modeIntensification.classList.remove('flex');
            console.log('Activated technique:', state.activeTechnique);
          });
        });
        
        document.getElementById('btn-back').addEventListener('click', function() {
          if (confirm('Quitter la session ?')) {
            window.location.href = 'workouts.html';
          }
        });
      }
      
      // ========== VALIDATE SET ==========
      function validateSet() {
        el.flashScreen.classList.add('flash');
        setTimeout(function() { el.flashScreen.classList.remove('flash'); }, 150);
        
        createParticles();
        
        var xpEarned = 50;
        if (state.selectedRIR <= 1) xpEarned += 10;
        if (state.activeTechnique) xpEarned += 20;
        
        addXP(xpEarned);
        showXPToast(xpEarned);
        
        state.sessionVolume += state.currentWeight * state.currentReps;
        
        logSetToHistory();
        
        document.getElementById('rpe-set').textContent = state.currentSet;
        document.getElementById('rpe-total-sets').textContent = state.exercises[state.currentExerciseIndex].sets;
        document.getElementById('rpe-weight').textContent = state.currentWeight;
        document.getElementById('rpe-reps').textContent = state.currentReps;
        
        var tempoScore = 75 + Math.floor(Math.random() * 25);
        var rangeScore = 85 + Math.floor(Math.random() * 15);
        var globalScore = Math.round((tempoScore + rangeScore) / 2);
        
        document.getElementById('score-tempo').textContent = tempoScore + '%';
        document.getElementById('score-tempo-bar').style.width = tempoScore + '%';
        document.getElementById('score-range').textContent = rangeScore + '%';
        document.getElementById('score-range-bar').style.width = rangeScore + '%';
        document.getElementById('score-global').textContent = globalScore;
        
        setTimeout(function() {
          el.modeRpe.classList.remove('hidden');
          el.modeRpe.classList.add('flex');
        }, 300);
      }
      
      function logSetToHistory() {
        try {
          var exercise = state.exercises[state.currentExerciseIndex];
          var entry = {
            id: 'set_' + Date.now(),
            timestamp: new Date().toISOString(),
            date: new Date().toLocaleDateString('fr-FR'),
            week: state.week,
            day: state.day,
            exercise: exercise.name,
            exerciseIndex: state.currentExerciseIndex,
            setNumber: state.currentSet,
            weight: state.currentWeight,
            reps: state.currentReps,
            targetWeight: exercise.weight,
            targetReps: exercise.reps,
            rpe: 10 - state.selectedRIR,
            technique: state.activeTechnique || 'STANDARD',
            tags: state.selectedTags.slice()
          };
          
          var history = [];
          try {
            history = JSON.parse(localStorage.getItem(STORAGE.history)) || [];
          } catch (e) {}
          
          history.push(entry);
          
          if (history.length > 1000) history.shift();
          
          localStorage.setItem(STORAGE.history, JSON.stringify(history));
          console.log('Set logged:', entry);
        } catch (error) {
          console.error('Error logging set:', error);
        }
      }
      
      // ========== REST TIMER ==========
      function startRest() {
        state.isResting = true;
        state.restRemaining = state.restTime;
        state.selectedTags = [];
        document.querySelectorAll('.tag-btn').forEach(function(btn) { btn.classList.remove('active'); });
        
        el.modeRepos.classList.remove('hidden');
        el.modeRepos.classList.add('flex');
        el.modeSerie.classList.add('hidden');
        
        updateRestDisplay();
        updateNextExercisePreview();
        
        if (state.restInterval) clearInterval(state.restInterval);
        
        state.restInterval = setInterval(function() {
          if (!state.isResting) {
            clearInterval(state.restInterval);
            return;
          }
          
          state.restRemaining--;
          updateRestDisplay();
          
          if (state.restRemaining <= 0) {
            clearInterval(state.restInterval);
            endRest();
          }
        }, 1000);
      }
      
      function updateRestDisplay() {
        var minutes = Math.floor(state.restRemaining / 60);
        var seconds = state.restRemaining % 60;
        el.restTimer.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        
        var totalMinutes = Math.floor(state.restTime / 60);
        var totalSeconds = state.restTime % 60;
        el.restTotal.textContent = totalMinutes + ':' + (totalSeconds < 10 ? '0' : '') + totalSeconds;
        
        var circumference = 2 * Math.PI * 110;
        var progress = state.restRemaining / state.restTime;
        var offset = circumference * (1 - progress);
        el.restProgress.style.strokeDashoffset = offset;
        
        var markerPos = (1 - progress) * 100;
        el.optimalMarker.style.left = markerPos + '%';
      }
      
      function endRest() {
        state.isResting = false;
        if (state.restInterval) clearInterval(state.restInterval);
        
        el.modeRepos.classList.add('hidden');
        el.modeRepos.classList.remove('flex');
        el.modeSerie.classList.remove('hidden');
        
        var exercise = state.exercises[state.currentExerciseIndex];
        if (state.currentSet < exercise.sets) {
          state.currentSet++;
          state.currentReps = 0;
          state.activeTechnique = null;
          updateUI();
        } else {
          loadExercise(state.currentExerciseIndex + 1);
        }
      }
      
      // ========== XP SYSTEM ==========
      function addXP(amount) {
        var current = parseInt(localStorage.getItem(STORAGE.xp) || '0');
        var newXP = current + amount;
        localStorage.setItem(STORAGE.xp, newXP);
        
        if (window.GamificationV4) {
          window.GamificationV4.addXP(amount);
        }
        
        return newXP;
      }
      
      function showXPToast(amount) {
        el.xpAmount.textContent = '+' + amount + ' XP';
        el.xpToast.classList.remove('opacity-0');
        el.xpToast.classList.add('xp-toast');
        
        setTimeout(function() {
          el.xpToast.classList.add('opacity-0');
          el.xpToast.classList.remove('xp-toast');
        }, 2000);
      }
      
      // ========== EFFECTS ==========
      function createParticles() {
        for (var i = 0; i < 3; i++) {
          (function(delay) {
            setTimeout(function() {
              var particle = document.createElement('div');
              particle.className = 'particle-ring';
              particle.style.animationDelay = delay * 0.1 + 's';
              el.particleContainer.appendChild(particle);
              
              setTimeout(function() { particle.remove(); }, 700);
            }, delay * 100);
          })(i);
        }
      }
      
      function animateTempoBars() {
        el.tempoDescent.style.height = '100%';
        setTimeout(function() {
          el.tempoDescent.style.height = '0%';
          el.tempoLift.style.height = '100%';
          setTimeout(function() {
            el.tempoLift.style.height = '0%';
          }, 2000);
        }, 3000);
      }
      
      // ========== FINISH WORKOUT ==========
      function finishWorkout() {
        var duration = Math.round((new Date() - state.sessionStartTime) / 60000);
        var workoutXP = 200 + Math.round(state.sessionVolume / 100);
        addXP(workoutXP);
        
        var sessionData = {
          week: state.week,
          day: state.day,
          duration: duration,
          volume: state.sessionVolume,
          xp: workoutXP,
          timestamp: new Date().toISOString()
        };
        
        localStorage.setItem(STORAGE.lastSession, JSON.stringify(sessionData));
        localStorage.setItem('neon_fit_last_workout', JSON.stringify(sessionData));
        
        window.location.href = 'debrief-v4.html';
      }
      
      // ========== START ==========
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
      
    })();
  </script>
  
</body>
</html>
